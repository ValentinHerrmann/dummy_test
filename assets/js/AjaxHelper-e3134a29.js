var b=Object.defineProperty;var T=(n,s,e)=>s in n?b(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var r=(n,s,e)=>(T(n,typeof s!="symbol"?s+"":s,e),e);import{j as p}from"./jquery-e35240e7.js";class y{constructor(s,e){r(this,"nextStrategy");this.name=s,this.manager=e}}class w extends y{constructor(e){super("long-polling strategy",e);r(this,"isClosed");r(this,"csrfToken");r(this,"shortestTimeoutMs",6e4);r(this,"timeOpened",null);r(this,"abortController");this.isClosed=!1}open(){this.isClosed=!1,this.abortController=new AbortController,this.timeOpened=performance.now();let e=[["content-type","text/json"]];e.push(["x-token-pm",l]),this.csrfToken=l,e.push(["x-timeout",this.shortestTimeoutMs+""]);try{fetch("/servlet/registerLongpollingListener",{signal:this.abortController.signal,method:"POST",headers:e,body:JSON.stringify({})}).then(t=>{if(t.status!=200){console.log(`Long-polling listener got http-status: ${t.status} (${t.statusText})`);let o=Math.round(performance.now()-this.timeOpened)-4e3;o<this.shortestTimeoutMs&&(this.shortestTimeoutMs=o)}switch(t.status){case 200:t.json().then(o=>{this.manager.onMessage(o)}),this.reopen();break;case 502:case 504:this.reopen(1e3,!1);break;case 401:console.log("PushClientLongPollingStrategy: Got http status code 401, therefore stopping.");break;default:this.reopen(1e4,!1);break}}).catch(t=>{console.log(`Long-polling listener failed due to reason: ${t}`),this.reopen(1e4,!1)}).finally(()=>{this.abortController=null})}catch{this.reopen(1e4,!1)}}reopen(e=500,t=!0){this.isClosed||(e>500&&console.log(`Reopen long-polling listener in ${e/1e3} seconds...`),setTimeout(()=>{this.isClosed||this.open()},e))}async close(){var t;this.isClosed=!0,(t=this.abortController)==null||t.abort();let e=[["content-type","text/json"]];e.push(["x-token-pm",this.csrfToken]),await fetch("/servlet/unregisterLongpollingListener",{method:"POST",headers:e,body:JSON.stringify({})})}}class S extends y{constructor(e){super("websocket strategy",e);r(this,"csrfToken");r(this,"websocket");r(this,"isClosed");r(this,"openedTimestamp");r(this,"currentTimer")}open(){this.isClosed=!1;try{let e=(window.location.protocol.startsWith("https")?"wss://":"ws://")+window.location.host+"/servlet/pushWebsocket?csrfToken="+l;this.websocket=new WebSocket(e),this.websocket.onopen=t=>{this.openedTimestamp=performance.now()},this.websocket.onclose=t=>{console.log("Websocket has been closed, code: "+t.code+", reason: "+t.reason),this.isClosed=!0,t.code==1001&&performance.now()-this.openedTimestamp>1e4?(console.log("Reason was timeout, dt > 10s => Reopen!"),this.open()):(this.manager.onStrategyFailed(this),this.isClosed=!0)},this.websocket.onerror=t=>{console.log("Error on websocket, type: "+t.type),this.websocket.close(),this.manager.onStrategyFailed(this),this.isClosed=!0},this.websocket.onmessage=t=>{if(t.data=="pong")return;const o=JSON.parse(t.data);this.manager.onMessage(o)},this.currentTimer!=null&&clearTimeout(this.currentTimer),this.doPing()}catch{this.manager.onStrategyFailed(this),this.isClosed=!0}}doPing(){this.currentTimer=setTimeout(()=>{this.isClosed?this.currentTimer=null:(this.websocket.send("ping"),this.doPing())},25e3)}async close(){this.isClosed=!0,this.websocket.close()}}class k{constructor(s){r(this,"strategies",[]);r(this,"currentStrategy");r(this,"eventTypeToSubscriberInfoMap",new Map);this.baseURL=s,this.strategies=[new S(this),new w(this)];for(let e=this.strategies.length-2;e>=0;e--)this.strategies[e].nextStrategy=this.strategies[e+1]}subscribe(s,e){this.eventTypeToSubscriberInfoMap.set(s,{eventType:s,handler:e})}unsubscribe(s){this.eventTypeToSubscriberInfoMap.delete(s)}open(){this.currentStrategy==null&&(this.currentStrategy=this.strategies[0],console.log(`Opening ${this.currentStrategy.name}`),this.currentStrategy.open())}onMessage(s){var e;for(let t of s){if(t.eventType=="keepAlive")return;(e=this.eventTypeToSubscriberInfoMap.get(t.eventType))==null||e.handler(t.data)}}onStrategyFailed(s){if(s!=this.currentStrategy)return;let e=this.currentStrategy;this.currentStrategy=this.currentStrategy.nextStrategy;let t=`${e.name} failed. `;this.currentStrategy!=null?(t+=`=> Trying ${this.currentStrategy.name} in 3 seconds...`,setTimeout(()=>{console.log(`Opening ${this.currentStrategy.name}`),this.currentStrategy.open()},3e3)):t+="It was the last resort, unfortunately this client has no means to receive push-messages from server.",console.log(t)}close(){this.currentStrategy!=null&&(this.currentStrategy.close(),this.currentStrategy=null)}}const c=class c extends k{static subscribe(s,e){c.getInstance().subscribe(s,e)}static unsubscribe(s){c.getInstance().unsubscribe(s)}static getInstance(){return c.instance==null&&(c.instance=new c("")),c.instance}};r(c,"instance");let g=c;const a=class a{static registerPerformanceEntry(s,e){let t=a.performanceData.find(u=>u.url==s);t==null&&(t={count:0,sumTime:0,url:s},a.performanceData.push(t)),t.count++;let o=Math.round(performance.now()-e);t.sumTime+=o,a.performanceDataCount++}static sendDataToServer(){if(performance.now()-a.lastTimeSent>3*60*1e3){let s={data:a.performanceData};a.performanceData=[],a.performanceDataCount=0,a.lastTimeSent=performance.now(),x("collectPerformanceData",s,()=>{})}}};r(a,"performanceData",[]),r(a,"performanceDataCount",0),r(a,"lastTimeSent",performance.now());let m=a;var l="";function x(n,s,e,t){n.startsWith("http")||(n="servlet/"+n),f(!0);let o=performance.now(),u={};l!=null&&(u={"x-token-pm":l}),p.ajax({type:"POST",async:!0,data:JSON.stringify(s),contentType:"application/json",headers:u,url:n,success:function(i){if(m.registerPerformanceEntry(n,o),i.csrfToken!=null&&(l=i.csrfToken,g.getInstance().open()),f(!1),i.success!=null&&i.success==!1||typeof i=="string"&&i==""){let h="Fehler bei der Bearbeitung der Anfrage";i.message!=null&&(h=i.message),i.error!=null&&(h=i.error),h.indexOf("Not logged in")>=0,console.log("Netzwerkfehler: "+h),t&&t(h)}else e(i)},error:function(i,h){if(f(!1),t){let d="Server nicht erreichbar.";i.status!=0&&(d=""+i.status),t(h+": "+d);return}}})}function f(n){n?p(".jo_network-busy").show():p(".jo_network-busy").hide()}async function M(n=!1){let s=window.location.href,e=s.indexOf("csrfToken=");if(e>=0){let t=s.substring(e+10);t!=null&&t.length>0&&(l=t)}n&&await C("/servlet/retrieveNewCsrfToken",{})}async function C(n,s){let e=[["content-type","text/json"]];l!=null&&e.push(["x-token-pm",l]);try{let o=await(await fetch(n,{method:"POST",headers:e,body:JSON.stringify(s)})).json();return o.token!=null&&(l=o.token,g.getInstance().open()),o==null?alert("Fehler beim Übertragen der Daten."):o.success!=!0&&alert(`Fehler beim Übertragen der Daten:
`+o.message),o}catch(t){return{status:"Error",message:"Es ist ein Fehler aufgetreten: "+t}}}export{g as P,x as a,C as b,l as c,m as d,M as e};
//# sourceMappingURL=AjaxHelper-e3134a29.js.map
